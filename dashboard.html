<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SlimEasy - Your personalized dashboard for tracking weight loss, nutrition, and fitness goals">
    <meta name="theme-color" content="#4CAF50">
    <title>SlimEasy - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Preload critical assets -->
    <link rel="preload" href="theme.js" as="script">
    <link rel="preload" href="utils.js" as="script">
    <link rel="preload" href="slimeasylogo.jpg" as="image">
</head>
<body>
    <!-- Main Navigation -->
    <nav class="main-nav">
        <div class="main-nav-container">
            <a href="index.html" class="main-nav-logo">
                <img src="slimeasylogo.jpg" alt="SlimEasy">
                <span>SlimEasy</span>
            </a>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="main-nav-links" id="mainNavLinks">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="dashboard.html" class="nav-link active">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="tracker.html" class="nav-link">
                    <i class="fas fa-utensils"></i> Food Tracker
                </a>
                <a href="exercise.html" class="nav-link">
                    <i class="fas fa-running"></i> Exercise
                </a>
                <a href="#" class="nav-link" id="aiBuddyBtn">
                    <i class="fas fa-robot"></i> AI Buddy
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-welcome">
            <div class="welcome-left">
                <h1>Your Dashboard</h1>
                <p id="welcomeMessage"></p>
                <div class="dashboard-date" id="currentDate"></div>
                <button id="addWeeklyWeight" class="btn btn-primary mt-sm">
                    <i class="fas fa-weight mr-xs"></i> Record Weekly Weight
                </button>
            </div>
            <div class="welcome-right">
                <div class="theme-toggle">
                    <button id="themeToggleBtn" class="theme-btn" aria-label="Toggle dark/light mode">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                <div class="view-toggle">
                    <button id="viewWeekly" class="action-button active-view">
                        <i class="fas fa-calendar-week"></i> Weekly
                    </button>
                    <button id="viewMonthly" class="action-button">
                        <i class="fas fa-calendar-alt"></i> Monthly
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Header -->
        <section class="dashboard-header">
            <div class="motivational-quote" id="dailyMotivation">
                <i class="fas fa-quote-left"></i>
                <span id="quoteText">Success is the sum of small efforts, repeated day in and day out.</span>
                <i class="fas fa-quote-right"></i>
            </div>
        </section>
        
        <!-- Daily Tip -->
        <div class="daily-tip">
            <h3><i class="fas fa-lightbulb"></i> Daily Tip</h3>
            <p id="dailyTip">Stay consistent with your tracking. Research shows that people who log their food intake regularly lose more weight and keep it off longer.</p>
        </div>
        
        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-weight"></i>
                    </div>
                    <h3 class="stat-card-title">Current Weight</h3>
                </div>
                <div class="stat-card-value" id="currentWeight">--</div>
                <div class="stat-card-footer" id="weightChange">--</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h3 class="stat-card-title">Progress to Goal</h3>
                </div>
                <div class="stat-card-value" id="progressPercent">--</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer" id="remainingToGoal">--</div>
                <div class="weight-history mt-md" id="weightHistory">
                    <h4 class="mt-sm">Recent Weight Entries</h4>
                    <div id="weightHistoryEntries" class="weight-entries"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3 class="stat-card-title">Calories Today</h3>
                </div>
                <div class="stat-card-value" id="caloriesConsumed">--</div>
                <div class="progress-container">
                    <div class="progress-bar" id="caloriesBar" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer" id="caloriesRemaining">--</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <h3 class="stat-card-title">Estimated Completion</h3>
                </div>
                <div class="stat-card-value" id="estimatedDate">--</div>
                <div class="stat-card-footer" id="daysRemaining">--</div>
            </div>
        </div>
        
        <!-- Water Tracking -->
        <section class="card">
            <div class="card-header">
                <i class="fas fa-tint"></i>
                <h2 class="card-title">Water Intake Tracker</h2>
            </div>
            <div class="card-body">
                <p>Track your daily water intake to stay hydrated (goal: 8 glasses per day)</p>
                <div class="water-tracker">
                    <div id="waterGlasses"></div>
                    <div class="water-controls">
                        <button class="water-btn" id="addWater">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="water-btn" id="removeWater">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar progress-bar-water" id="waterProgress" style="width: 0%"></div>
                </div>
                <p id="waterStatus">0/8 glasses</p>
            </div>
        </section>
        
        <!-- Quick Add Foods -->
        <section class="card">
            <div class="card-header">
                <i class="fas fa-utensils"></i>
                <h2 class="card-title">Quick Add</h2>
            </div>
            <div class="card-body">
                <p>Quickly add common foods to today's log:</p>
                <div class="quick-add">
                    <button class="quick-add-btn" data-calories="200" data-name="Banana">
                        <i class="fas fa-apple-alt"></i> Banana
                    </button>
                    <button class="quick-add-btn" data-calories="165" data-name="Greek Yogurt">
                        <i class="fas fa-utensils"></i> Greek Yogurt
                    </button>
                    <button class="quick-add-btn" data-calories="200" data-name="Oatmeal">
                        <i class="fas fa-utensils"></i> Oatmeal
                    </button>
                    <button class="quick-add-btn" data-calories="270" data-name="Peanut Butter Sandwich">
                        <i class="fas fa-bread-slice"></i> PB Sandwich
                    </button>
                    <button class="quick-add-btn" data-calories="100" data-name="Apple">
                        <i class="fas fa-apple-alt"></i> Apple
                    </button>
                    <button class="quick-add-btn" data-calories="150" data-name="Coffee with Milk">
                        <i class="fas fa-coffee"></i> Coffee w/ Milk
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Charts -->
        <div class="card-grid">
            <section class="card">
                <div class="card-header">
                    <i class="fas fa-weight"></i>
                    <h2 class="card-title">Weight Trend</h2>
                </div>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </section>
            
            <section class="card">
                <div class="card-header">
                    <i class="fas fa-fire"></i>
                    <h2 class="card-title">Calorie Intake</h2>
                </div>
                <div class="chart-container">
                    <canvas id="calorieChart"></canvas>
                </div>
            </section>
            
            <section class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i>
                    <h2 class="card-title">Average Calories per Day</h2>
                </div>
                <div class="chart-container">
                    <canvas id="avgCalorieChart"></canvas>
                </div>
            </section>
            
            <section class="card">
                <div class="card-header">
                    <i class="fas fa-running"></i>
                    <h2 class="card-title">Exercise Activity</h2>
                </div>
                <div class="chart-container">
                    <canvas id="exerciseChart"></canvas>
                </div>
            </section>
        </div>
    </div>
    
    <script src="theme.js"></script>
    <script src="utils.js"></script>
    <script>
        // Initialize the dashboard when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize page (theme, menu, login check)
            if (initializePage()) {
                // Initialize dashboard components
                initializeDashboard();
                
                // Initialize AI Buddy
                initializeAIBuddy();
            }
        });
        
        /**
         * Initialize dashboard components and data
         */
        function initializeDashboard() {
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            // Get today's date information
            const today = new Date();
            const formattedDate = formatCurrentDate(today);
            
            // Set current date
            updateCurrentDate(formattedDate);
            
            // Set up weekly weight recording button
            document.getElementById('addWeeklyWeight').addEventListener('click', promptWeeklyWeight);
            
            // Get profile data
            const profileKey = `profile_${currentUser.email}`;
            const profile = getFromStorage(profileKey);
            
            if (!profile) {
                window.location.href = 'index.html';
                return;
            }
            
            // Store goal weight for calculations
            window.goalWeight = parseFloat(profile.goalWeight) || 0;
            
            // Store goal weight for calculations
            window.goalWeight = parseFloat(profile.goalWeight) || 0;
            
            // Initialize all dashboard components
            initializeStats(profile, today);
            initializeWaterTracker(today);
            initializeCharts(profile);
            initializeQuickAdd(today);
            loadDailyTip();
            setupThemeToggle();
            
            // Set up navigation buttons
            setupNavigation();
            setupViewToggles();
            
            // Add custom water tracker styling
            addWaterTrackerStyles();
        }
        
        /**
         * Update the current date display
         */
        function updateCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('en-US', options);
            }
        }
        
        /**
         * Set up navigation button event listeners
         */
        function setupNavigation() {
            // Profile button
            const profileBtn = document.getElementById('navProfile');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => window.location.href = 'index.html');
            }
            
            // Planner button
            const plannerBtn = document.getElementById('navPlanner');
            if (plannerBtn) {
                plannerBtn.addEventListener('click', () => window.location.href = 'tracker.html');
            }
            
            // Exercise button
            const exerciseBtn = document.getElementById('navExercise');
            if (exerciseBtn) {
                exerciseBtn.addEventListener('click', () => window.location.href = 'exercise.html');
            }
        }
        
        /**
         * Set up view toggle buttons (weekly/monthly)
         */
        function setupViewToggles() {
            const weeklyBtn = document.getElementById('viewWeekly');
            const monthlyBtn = document.getElementById('viewMonthly');
            
            if (weeklyBtn && monthlyBtn) {
                weeklyBtn.addEventListener('click', function() {
                    this.classList.add('active-view');
                    monthlyBtn.classList.remove('active-view');
                    updateCharts('weekly');
                });
                
                monthlyBtn.addEventListener('click', function() {
                    this.classList.add('active-view');
                    weeklyBtn.classList.remove('active-view');
                    updateCharts('monthly');
                });
            }
        }
        
        /**
         * Add custom water tracker styling
         */
        function addWaterTrackerStyles() {
            // Create style element
            const style = document.createElement('style');
            style.textContent = `
                .water-tracker {
                    display: flex;
                    align-items: center;
                    gap: 20px;
                    margin: 25px 0;
                }
                
                #waterGlasses {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                }
                
                .water-glass {
                    width: 35px;
                    height: 50px;
                    background-color: var(--progress-bg);
                    border-radius: 8px;
                    cursor: pointer;
                    position: relative;
                    transition: all var(--transition-speed);
                    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
                }
                
                .water-glass.filled {
                    background-color: var(--progress-water);
                    box-shadow: 0 2px 5px rgba(41, 182, 246, 0.3);
                }
                
                .water-glass:hover {
                    transform: translateY(-3px);
                }
                
                /* Water glass animation */
                .water-glass.filled::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(
                        135deg,
                        rgba(255, 255, 255, 0.1) 0%,
                        rgba(255, 255, 255, 0.2) 50%,
                        transparent 50%,
                        transparent 100%
                    );
                    border-radius: 7px;
                    z-index: 1;
                }
                
                .water-controls {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    margin-left: 10px;
                }
                
                .water-btn {
                    background: var(--gradient-info);
                    color: white;
                    border: none;
                    width: 45px;
                    height: 45px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    font-size: 18px;
                    transition: all var(--transition-speed);
                    box-shadow: 0 3px 8px rgba(41, 121, 255, 0.3);
                    padding: 0;
                    margin: 0;
                }
                
                .water-btn:hover {
                    transform: scale(1.15);
                    box-shadow: 0 5px 12px rgba(41, 121, 255, 0.4);
                }
                
                .water-btn:active {
                    transform: scale(0.95);
                }
                
                #waterStatus {
                    margin-top: 10px;
                    color: var(--progress-water);
                    font-weight: 500;
                    font-size: 16px;
                }
            `;
            
            // Add to document
            document.head.appendChild(style);
        }
        
        // Check for logged-in user
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // Display welcome message
            document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.name}`;
            
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            
            // Get profile data
            const profileKey = `profile_${currentUser.email}`;
            const profile = JSON.parse(localStorage.getItem(profileKey));
            
            if (!profile) {
                window.location.href = 'index.html';
                return;
            }
            
            // Process and display profile data
            initializeStats(profile);
            initializeWaterTracker();
            initializeCharts(profile);
            initializeQuickAdd();
            loadDailyTip();
        });
        
        // Navigation
        document.getElementById('navProfile').addEventListener('click', () => window.location.href = 'index.html');
        document.getElementById('navPlanner').addEventListener('click', () => window.location.href = 'tracker.html');
        document.getElementById('navExercise').addEventListener('click', () => window.location.href = 'exercise.html');
        
        // View toggles
        document.getElementById('viewWeekly').addEventListener('click', function() {
            this.classList.add('active-view');
            document.getElementById('viewMonthly').classList.remove('active-view');
            updateCharts('weekly');
        });
        
        document.getElementById('viewMonthly').addEventListener('click', function() {
            this.classList.add('active-view');
            document.getElementById('viewWeekly').classList.remove('active-view');
            updateCharts('monthly');
        });
        
        // Initialize dashboard stats
        function initializeStats(profile, today) {
            if (!profile) return;
            
            // Current weight with fallback checks
            const weight = parseFloat(profile.weight) || 0;
            const weightUnit = profile.weightUnit || 'kg';
            const weightDisplay = weightUnit === 'kg' 
                ? `${weight} kg` 
                : `${weight} lb`;
            
            const currentWeightElement = document.getElementById('currentWeight');
            if (currentWeightElement) {
                currentWeightElement.textContent = weightDisplay;
            }
            
            // Calculate weight difference
            const weightStart = weight;
            const weeklyWeightData = getWeeklyWeightData();
            const latestWeight = weeklyWeightData.length > 1 ? weeklyWeightData[weeklyWeightData.length - 1] : weightStart;
            const weightDifference = latestWeight - weightStart;
            
            // Display weight change
            const weightChangeElement = document.getElementById('weightChange');
            if (weightChangeElement) {
                const weightChangeDisplay = weightDifference >= 0 
                    ? `+${weightDifference.toFixed(1)} ${weightUnit}` 
                    : `${weightDifference.toFixed(1)} ${weightUnit}`;
                weightChangeElement.textContent = `Since start: ${weightChangeDisplay}`;
            }
            
            // Calculate progress percentage with improved safeguards
            const goalWeight = parseFloat(profile.goalWeight) || 0;
            // Use default values if values are invalid
            const weightStartFloat = parseFloat(weightStart) || 0;
            const latestWeightFloat = parseFloat(latestWeight) || weightStartFloat;
            
            // Ensure valid numerical values for all calculations
            const totalToLose = Math.max(0.1, weightStartFloat - goalWeight); // Ensure we don't divide by zero
            const lost = Math.max(0, weightStartFloat - latestWeightFloat); // Ensure we don't have negative loss
            
            // Calculate progress percentage safely
            let progressPercent = 0;
            if (totalToLose > 0 && isFinite(totalToLose) && isFinite(lost)) {
                progressPercent = (lost / totalToLose) * 100;
                // Cap at 100% and avoid negative values
                progressPercent = Math.min(100, Math.max(0, progressPercent));
            }
            
            // Update progress display
            const progressPercentElement = document.getElementById('progressPercent');
            const progressBarElement = document.getElementById('progressBar');
            
            if (progressPercentElement) {
                progressPercentElement.textContent = `${Math.round(progressPercent)}%`;
            }
            
            if (progressBarElement) {
                progressBarElement.style.width = `${progressPercent}%`;
            }
            
            // Remaining to goal - handle negative values properly with improved NaN protection
            const remainingToLose = Math.max(0, latestWeightFloat - goalWeight);
            const remainingToGoalElement = document.getElementById('remainingToGoal');
            if (remainingToGoalElement) {
                if (remainingToLose <= 0 || !isFinite(remainingToLose)) {
                    remainingToGoalElement.textContent = `Goal reached! ðŸŽ‰`;
                } else {
                    remainingToGoalElement.textContent = `${remainingToLose.toFixed(1)} ${weightUnit} to go`;
                }
            }
            
            // Get current day index
            const date = today || new Date();
            const day = date.getDay(); // 0 = Sunday
            const dayIndex = day === 0 ? 6 : day - 1; // Convert to 0 = Monday
            
            // Get current user
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            // Get food and exercise data
            const userKey = `planner_${currentUser.email}`;
            let weeklyCalories, weeklyExercise;
            
            try {
                weeklyCalories = JSON.parse(localStorage.getItem(`${userKey}_calories`)) || [0, 0, 0, 0, 0, 0, 0];
                if (!Array.isArray(weeklyCalories) || weeklyCalories.length !== 7) {
                    weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
                }
            } catch (e) {
                console.error('Error parsing calories:', e);
                weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
            }
            
            try {
                weeklyExercise = JSON.parse(localStorage.getItem(`${userKey}_exercise`)) || [0, 0, 0, 0, 0, 0, 0];
                if (!Array.isArray(weeklyExercise) || weeklyExercise.length !== 7) {
                    weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
                }
            } catch (e) {
                console.error('Error parsing exercise:', e);
                weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
            }
            
            // Calculate calorie values
            const caloriesConsumed = parseFloat(weeklyCalories[dayIndex]) || 0;
            const caloriesBurned = parseFloat(weeklyExercise[dayIndex]) || 0;
            const netCalories = caloriesConsumed - caloriesBurned;
            const dailyGoal = parseFloat(profile.dailyGoal) || 2000; // Default if missing
            
            // Update calorie display
            const caloriesConsumedElement = document.getElementById('caloriesConsumed');
            if (caloriesConsumedElement) {
                caloriesConsumedElement.textContent = `${netCalories} / ${Math.round(dailyGoal)} kcal`;
            }
            
            // Calculate calorie bar percentage
            const caloriePercent = dailyGoal > 0 ? (netCalories / dailyGoal) * 100 : 0;
            const caloriesBarElement = document.getElementById('caloriesBar');
            if (caloriesBarElement) {
                caloriesBarElement.style.width = `${Math.min(100, Math.max(0, caloriePercent))}%`;
            }
            
            // Calories remaining
            const caloriesRemaining = dailyGoal - netCalories;
            const caloriesRemainingElement = document.getElementById('caloriesRemaining');
            if (caloriesRemainingElement) {
                caloriesRemainingElement.textContent = caloriesRemaining > 0 
                    ? `${Math.round(caloriesRemaining)} kcal remaining` 
                    : `${Math.abs(Math.round(caloriesRemaining))} kcal over budget`;
            }
            
            // Estimated completion date with better calculation
            const dailyDeficit = parseFloat(profile.dailyDeficit) || 500; // Default if missing
            const caloriesPerKg = 7700; // Standard caloric value per kg of body weight
            
            // Calculate weight loss per week based on deficit
            // Conservative estimate: factor in diminishing returns as weight decreases
            const weightLossPerWeek = (dailyDeficit > 0) 
                ? (dailyDeficit * 7) / caloriesPerKg * 0.85 // Apply 15% reduction factor for metabolic adaptation
                : 0;
            
            let weeksToGoal, estimatedDate, daysRemaining;
            
            if (weightLossPerWeek > 0 && remainingToLose > 0) {
                // Apply a progressive slowdown factor as we get closer to goal
                const adjustedWeightLossPerWeek = weightLossPerWeek * (0.9 + (0.1 * (remainingToLose / totalToLose)));
                
                // Calculate weeks to goal with this adjusted rate
                weeksToGoal = remainingToLose / adjustedWeightLossPerWeek;
                
                // Set reasonable bounds
                if (weeksToGoal > 520) { // Cap at 10 years
                    weeksToGoal = 520;
                }
                
                // Calculate estimated completion date
                estimatedDate = new Date();
                estimatedDate.setDate(estimatedDate.getDate() + Math.round(weeksToGoal * 7));
                daysRemaining = Math.round(weeksToGoal * 7);
                
                // Add a buffer for realistic estimation (typically weight loss slows over time)
                const buffer = Math.round(daysRemaining * 0.1); // 10% buffer
                estimatedDate.setDate(estimatedDate.getDate() + buffer);
                daysRemaining += buffer;
            } else if (remainingToLose <= 0) {
                // Goal already reached
                estimatedDate = new Date();
                daysRemaining = 'Goal reached!';
            } else {
                // Default fallback if we can't calculate
                estimatedDate = new Date();
                estimatedDate.setDate(estimatedDate.getDate() + 90); // Default to 90 days
                daysRemaining = 'Calculating...';
            }
            
            // Update estimated date display
            const estimatedDateElement = document.getElementById('estimatedDate');
            if (estimatedDateElement) {
                if (remainingToLose <= 0) {
                    estimatedDateElement.textContent = 'Goal already achieved!';
                } else {
                    estimatedDateElement.textContent = estimatedDate.toLocaleDateString('en-US', {
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric'
                    });
                }
            }
            
            const daysRemainingElement = document.getElementById('daysRemaining');
            if (daysRemainingElement) {
                if (typeof daysRemaining === 'number') {
                    daysRemainingElement.textContent = `~${daysRemaining} days remaining`;
                } else {
                    daysRemainingElement.textContent = daysRemaining;
                }
            }
        }
        
        /**
         * Format current date in a friendly format
         * @param {Date} date - Date object to format
         * @returns {string} Formatted date string
         */
        function formatCurrentDate(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('en-US', options);
        }
        
        /**
         * Update current date display
         * @param {string} formattedDate - Formatted date string
         */
        function updateCurrentDate(formattedDate) {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = formattedDate;
            }
        }
        
        /**
         * Initialize water tracker
         * @param {Date} date - Current date
         */
        function initializeWaterTracker(date) {
            // Get current user
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            // Format date for storage key - YYYY-MM-DD
            const dateStr = date.toISOString().split('T')[0];
            const waterKey = `water_${currentUser.email}_${dateStr}`;
            
            // Get existing water count from storage
            let waterCount = parseInt(localStorage.getItem(waterKey) || '0');
            
            // Update display
            updateWaterDisplay(waterCount);
            
            // Add water glass
            const addWaterBtn = document.getElementById('addWater');
            if (addWaterBtn) {
                addWaterBtn.addEventListener('click', function() {
                    if (waterCount < 8) {
                        waterCount++;
                        localStorage.setItem(waterKey, waterCount);
                        updateWaterDisplay(waterCount);
                        showNotification('Water intake updated!', 'success');
                    }
                });
            }
            
            // Remove water glass
            const removeWaterBtn = document.getElementById('removeWater'); 
            if (removeWaterBtn) {
                removeWaterBtn.addEventListener('click', function() {
                    if (waterCount > 0) {
                        waterCount--;
                        localStorage.setItem(waterKey, waterCount);
                        updateWaterDisplay(waterCount);
                    }
                });
            }
        }
        
        /**
         * Update water display
         * @param {number} count - Number of water glasses
         */
        function updateWaterDisplay(count) {
            const container = document.getElementById('waterGlasses');
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            // Create water glasses
            for (let i = 0; i < 8; i++) {
                const glass = document.createElement('div');
                glass.className = i < count ? 'water-glass filled' : 'water-glass';
                container.appendChild(glass);
                
                // Add click handler to each glass
                glass.addEventListener('click', function() {
                    // Get current user
                    const currentUser = getFromStorage('currentUser');
                    if (!currentUser) return;
                    
                    // Get current date
                    const today = new Date().toISOString().split('T')[0];
                    const waterKey = `water_${currentUser.email}_${today}`;
                    
                    // Toggle glass state
                    let newCount = 0;
                    if (i < count) {
                        // If clicking on filled glass, empty this and all after
                        newCount = i;
                    } else {
                        // If clicking on empty glass, fill this and all before
                        newCount = i + 1;
                    }
                    
                    // Save to storage
                    localStorage.setItem(waterKey, newCount);
                    
                    // Update display
                    updateWaterDisplay(newCount);
                });
            }
            
            // Update progress bar
            const progressBar = document.getElementById('waterProgress');
            if (progressBar) {
                const percent = (count / 8) * 100;
                progressBar.style.width = `${percent}%`;
            }
            
            // Update status text
            const statusElement = document.getElementById('waterStatus');
            if (statusElement) {
                statusElement.textContent = `${count}/8 glasses`;
            }
        }
        
        // Get weekly weight data with proper error handling and validation
        function getWeeklyWeightData() {
            try {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return [];
                
                const profileKey = `profile_${currentUser.email}`;
                const profile = getFromStorage(profileKey);
                if (!profile) return [];
                
                // Check if we have stored weight data
                const weightDataKey = `weight_history_${currentUser.email}`;
                let weightData = getFromStorage(weightDataKey, null);
                
                if (!weightData || !Array.isArray(weightData) || weightData.length === 0) {
                    // Generate data if none exists
                    const startWeight = parseFloat(profile.weight) || 70;
                    const goalWeight = parseFloat(profile.goalWeight) || (startWeight - 5);
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 28); // 4 weeks ago
                    
                    weightData = [];
                    
                    // Generate more realistic weight loss data
                    for (let i = 0; i < 4; i++) {
                        const date = new Date(startDate);
                        date.setDate(date.getDate() + (i * 7));
                        
                        // More natural fluctuation
                        const fluctuation = (Math.random() * 0.4) - 0.2;
                        
                        // Progressive weight loss with diminishing returns
                        const weeksSoFar = i + 1;
                        const progressFactor = 1 - (weeksSoFar / 12); // Diminishing return factor
                        const weeklyLoss = 0.5 * progressFactor; // Base weekly loss of 0.5 units
                        
                        const totalLoss = weeklyLoss * weeksSoFar;
                        const weekWeight = Math.max(
                            goalWeight, 
                            startWeight - totalLoss + fluctuation
                        ).toFixed(1);
                        
                        weightData.push({
                            date: date.toISOString().split('T')[0],
                            weight: parseFloat(weekWeight)
                        });
                    }
                    
                    saveToStorage(weightDataKey, weightData);
                }
                
                // Add current weight if it's missing from the data
                const currentWeight = parseFloat(profile.weight) || 70;
                if (weightData.length > 0 && 
                    Math.abs(weightData[weightData.length - 1].weight - currentWeight) > 0.1) {
                    weightData.push({
                        date: new Date().toISOString().split('T')[0],
                        weight: currentWeight
                    });
                    
                    // Keep only the most recent 12 entries to avoid chart clutter
                    if (weightData.length > 12) {
                        weightData = weightData.slice(weightData.length - 12);
                    }
                    
                    saveToStorage(weightDataKey, weightData);
                }
                
                // Update the weight history display
                updateWeightHistoryDisplay(weightData);
                
                return weightData;
            } catch (error) {
                console.error('Error getting weight data:', error);
                return [];
            }
        }
        
        // Add new weight entry for current week
        function addWeeklyWeightEntry(weight, isStartWeight = false) {
            try {
                if (!weight || isNaN(parseFloat(weight))) {
                    throw new Error('Invalid weight value');
                }
                
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return false;
                
                const weightDataKey = `weight_history_${currentUser.email}`;
                let weightData = getFromStorage(weightDataKey, []);
                
                if (!Array.isArray(weightData)) {
                    weightData = [];
                }
                
                // Add new entry with today's date
                const today = new Date().toISOString().split('T')[0];
                
                // Check if we already have an entry for today
                const todayEntryIndex = weightData.findIndex(entry => entry.date === today);
                const newEntry = {
                    date: today,
                    weight: parseFloat(weight),
                    isStartWeight: isStartWeight
                };
                
                // If this is a starting weight, clear any existing start weights
                if (isStartWeight) {
                    weightData = weightData.map(entry => ({
                        ...entry,
                        isStartWeight: false
                    }));
                }
                
                if (todayEntryIndex >= 0) {
                    // Update existing entry for today
                    weightData[todayEntryIndex] = newEntry;
                } else {
                    // Add new entry
                    weightData.push(newEntry);
                }
                
                // Keep only the most recent 12 entries
                if (weightData.length > 12) {
                    weightData = weightData.slice(weightData.length - 12);
                }
                
                // Save updated data
                saveToStorage(weightDataKey, weightData);
                
                // Update profile with new weight and starting weight if applicable
                const profileKey = `profile_${currentUser.email}`;
                const profile = getFromStorage(profileKey);
                if (profile) {
                    // If it's a starting weight or there's no current weight, update profile weight
                    if (isStartWeight || !profile.weight) {
                        profile.weight = parseFloat(weight);
                    }
                    
                    // If it's marked as starting weight, store it specifically
                    if (isStartWeight) {
                        profile.startWeight = parseFloat(weight);
                        
                        // If no goal weight is set, suggest one based on starting weight
                        if (!profile.goalWeight) {
                            // Default goal: lose 10% of starting weight
                            const suggestedGoal = Math.round(parseFloat(weight) * 0.9 * 10) / 10;
                            profile.goalWeight = suggestedGoal;
                        }
                    }
                    
                    saveToStorage(profileKey, profile);
                }
                
                // Update the UI
                updateWeightHistoryDisplay(weightData);
                initializeStats(getFromStorage(profileKey), new Date());
                updateCharts(document.getElementById('viewMonthly').classList.contains('active-view') ? 'monthly' : 'weekly');
                
                return true;
            } catch (error) {
                console.error('Error adding weight entry:', error);
                return false;
            }
        }
        
        // Update the weight history display
        function updateWeightHistoryDisplay(weightData) {
            const entriesContainer = document.getElementById('weightHistoryEntries');
            if (!entriesContainer || !Array.isArray(weightData)) return;
            
            // Clear existing entries
            entriesContainer.innerHTML = '';
            
            // Get the weight unit from the profile
            const currentUser = getFromStorage('currentUser');
            const profileKey = currentUser ? `profile_${currentUser.email}` : null;
            const profile = profileKey ? getFromStorage(profileKey) : null;
            const weightUnit = profile && profile.weightUnit ? profile.weightUnit : 'kg';
            
            // Sort entries by date (newest first)
            const sortedData = [...weightData].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            // Add entries to the display
            sortedData.forEach((entry, index) => {
                const entryElement = document.createElement('div');
                entryElement.className = 'weight-entry';
                
                const dateObj = new Date(entry.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Add a marker for starting weight
                let weightLabel = `${entry.weight} ${weightUnit}`;
                if (entry.isStartWeight) {
                    weightLabel += ' <span class="start-weight-badge">Start</span>';
                }
                
                entryElement.innerHTML = `
                    <span class="weight-entry-date">${formattedDate}</span>
                    <span class="weight-entry-value">${weightLabel}</span>
                    <button class="delete-entry-btn" aria-label="Remove entry" data-date="${entry.date}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                entriesContainer.appendChild(entryElement);
                
                // Add event listener to the delete button
                const deleteBtn = entryElement.querySelector('.delete-entry-btn');
                deleteBtn.addEventListener('click', function() {
                    const entryDate = this.getAttribute('data-date');
                    removeWeightEntry(entryDate);
                });
            });
        }
        
        // Prompt for weekly weight recording
        function promptWeeklyWeight() {
            // Get weight unit from profile
            const currentUser = getFromStorage('currentUser');
            const profileKey = `profile_${currentUser.email}`;
            const profile = getFromStorage(profileKey);
            const weightUnit = profile && profile.weightUnit ? profile.weightUnit : 'kg';
            
            // Show input prompt with options
            const options = ['Current Weight', 'Starting Weight'];
            const selectedOption = prompt(`What would you like to record?\n1. Current Weight\n2. Starting Weight\n\nEnter 1 or 2:`);
            
            if (selectedOption === null) return;
            
            const isStartWeight = selectedOption.trim() === '2';
            const promptMessage = isStartWeight 
                ? `Enter your starting weight (${weightUnit}):` 
                : `Enter your current weight (${weightUnit}):`;
            
            const weight = prompt(promptMessage); 
            
            if (weight !== null && weight.trim() !== '') {
                // Validate input
                const weightValue = parseFloat(weight);
                if (!isNaN(weightValue) && weightValue > 0 && weightValue < 500) {
                    // Add the weight entry
                    if (addWeeklyWeightEntry(weightValue, isStartWeight)) {
                        alert(isStartWeight ? 'Starting weight recorded successfully!' : 'Weight recorded successfully!');
                    } else {
                        alert('Failed to record weight. Please try again.');
                    }
                } else {
                    alert('Please enter a valid weight.');
                }
            }
        }
        
        // Setup theme toggle button
        function setupThemeToggle() {
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (!themeToggleBtn) return;
            
            // Set initial state based on current theme
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                themeToggleBtn.querySelector('i').className = 'fas fa-sun';
            } else {
                themeToggleBtn.querySelector('i').className = 'fas fa-moon';
            }
            
            // Add event listener
            themeToggleBtn.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                // Update icon
                this.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                
                // Set theme
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update charts if they exist
                if (window.weightChart) window.weightChart.update();
                if (window.calorieChart) window.calorieChart.update();
                if (window.avgCalorieChart) window.avgCalorieChart.update();
                if (window.exerciseChart) window.exerciseChart.update();
            });
        }
        
        // Remove a weight entry
        function removeWeightEntry(entryDate) {
            if (!confirm('Are you sure you want to remove this weight entry?')) {
                return false;
            }
            
            try {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return false;
                
                const weightDataKey = `weight_history_${currentUser.email}`;
                let weightData = getFromStorage(weightDataKey, []);
                
                if (!Array.isArray(weightData) || weightData.length === 0) {
                    return false;
                }
                
                // Filter out the entry with the matching date
                const filteredData = weightData.filter(entry => entry.date !== entryDate);
                
                // If no entries were removed, return false
                if (filteredData.length === weightData.length) {
                    return false;
                }
                
                // Save the filtered data
                saveToStorage(weightDataKey, filteredData);
                
                // Update the UI
                updateWeightHistoryDisplay(filteredData);
                
                // Get the profile and update charts
                const profileKey = `profile_${currentUser.email}`;
                const profile = getFromStorage(profileKey);
                
                // Reinitialize stats and charts
                initializeStats(profile, new Date());
                updateCharts(document.getElementById('viewMonthly').classList.contains('active-view') ? 'monthly' : 'weekly');
                
                return true;
            } catch (error) {
                console.error('Error removing weight entry:', error);
                return false;
            }
        }
        
        // Initialize AI Buddy
        function initializeAIBuddy() {
            const aiBuddyBtn = document.getElementById('aiBuddyBtn');
            const aiBuddyModal = document.getElementById('aiBuddyModal');
            const aiBuddyClose = document.getElementById('aiBuddyClose');
            const aiMessageInput = document.getElementById('aiMessageInput');
            const aiSendBtn = document.getElementById('aiSendBtn');
            const aiChatMessages = document.getElementById('aiChatMessages');
            const aiTyping = document.getElementById('aiTyping');
            
            if (!aiBuddyBtn || !aiBuddyModal) return;
            
            // Open AI Buddy modal
            aiBuddyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                aiBuddyModal.classList.add('show');
                aiMessageInput.focus();
                
                // Prepopulate suggestions based on user data
                generateAISuggestions();
            });
            
            // Close AI Buddy modal
            aiBuddyClose.addEventListener('click', function() {
                aiBuddyModal.classList.remove('show');
            });
            
            // Close when clicking outside the modal content
            aiBuddyModal.addEventListener('click', function(e) {
                if (e.target === aiBuddyModal) {
                    aiBuddyModal.classList.remove('show');
                }
            });
            
            // Send message on button click
            aiSendBtn.addEventListener('click', sendAIMessage);
            
            // Send message on Enter key
            aiMessageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
            
            // Function to send message to AI Buddy
            function sendAIMessage() {
                const message = aiMessageInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addMessageToChat('user', message);
                
                // Clear input
                aiMessageInput.value = '';
                
                // Show typing indicator
                aiTyping.style.display = 'flex';
                
                // Scroll to bottom
                scrollAIChat();
                
                // Generate AI response after a delay (simulating processing)
                setTimeout(() => {
                    // Hide typing indicator
                    aiTyping.style.display = 'none';
                    
                    // Generate response based on message and user data
                    const response = generateAIResponse(message);
                    
                    // Add AI response to chat
                    addMessageToChat('buddy', response);
                    
                    // Scroll to bottom
                    scrollAIChat();
                }, 1500);
            }
            
            // Add message to chat
            function addMessageToChat(type, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${type}`;
                messageDiv.textContent = text;
                aiChatMessages.appendChild(messageDiv);
            }
            
            // Scroll chat to bottom
            function scrollAIChat() {
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            }
            
            // Generate AI suggestions based on user data
            function generateAISuggestions() {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser) return;
                
                const profileKey = `profile_${currentUser.email}`;
                const profile = getFromStorage(profileKey);
                
                const weightDataKey = `weight_history_${currentUser.email}`;
                const weightData = getFromStorage(weightDataKey, []);
                
                // Don't add suggestions if they already exist
                if (document.querySelector('.ai-suggestion')) return;
                
                // Create a wrapper for suggestions
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.className = 'ai-suggestions';
                
                // Add heading
                const heading = document.createElement('div');
                heading.style.margin = '20px 0 15px';
                heading.style.fontWeight = 'bold';
                heading.style.color = 'var(--accent-color)';
                heading.textContent = 'Personalized Recommendations';
                suggestionsDiv.appendChild(heading);
                
                // Create meal suggestion
                const mealSuggestion = createSuggestion(
                    'Meal Suggestion',
                    generateMealSuggestion(profile),
                    'Based on your calorie goals'
                );
                suggestionsDiv.appendChild(mealSuggestion);
                
                // Create exercise suggestion
                const exerciseSuggestion = createSuggestion(
                    'Exercise Tip',
                    generateExerciseSuggestion(profile, weightData),
                    'Based on your progress'
                );
                suggestionsDiv.appendChild(exerciseSuggestion);
                
                // Create motivation suggestion
                const motivationSuggestion = createSuggestion(
                    'Daily Motivation',
                    generateMotivationSuggestion(weightData),
                    'Keep going!'
                );
                suggestionsDiv.appendChild(motivationSuggestion);
                
                // Add suggestions to chat
                aiChatMessages.appendChild(suggestionsDiv);
                
                // Scroll to show suggestions
                scrollAIChat();
            }
            
            // Create a suggestion element
            function createSuggestion(title, content, meta) {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'ai-suggestion';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'ai-suggestion-title';
                titleDiv.textContent = title;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'ai-suggestion-content';
                contentDiv.textContent = content;
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'ai-suggestion-meta';
                metaDiv.textContent = meta;
                
                suggestionDiv.appendChild(titleDiv);
                suggestionDiv.appendChild(contentDiv);
                suggestionDiv.appendChild(metaDiv);
                
                return suggestionDiv;
            }
            
            // Generate AI response based on message and user data
            function generateAIResponse(message) {
                message = message.toLowerCase();
                
                // Basic keyword matching for responses
                if (message.includes('meal') || message.includes('food') || message.includes('eat')) {
                    return generateMealSuggestion();
                } else if (message.includes('exercise') || message.includes('workout') || message.includes('activity')) {
                    return generateExerciseSuggestion();
                } else if (message.includes('motivation') || message.includes('inspire') || message.includes('help me')) {
                    return generateMotivationSuggestion();
                } else if (message.includes('weight') || message.includes('progress')) {
                    return generateProgressInsight();
                } else if (message.includes('thanks') || message.includes('thank you')) {
                    return "You're welcome! I'm here to help you on your weight loss journey. Let me know if you need any other assistance!";
                } else {
                    // Default response
                    return "I'm here to help with meal suggestions, exercise tips, progress tracking, and motivation. What specific area would you like help with today?";
                }
            }
            
            // Generate meal suggestion based on user profile
            function generateMealSuggestion(profile) {
                const mealSuggestions = [
                    "Greek yogurt with berries and a sprinkle of granola for a protein-packed breakfast.",
                    "Grilled chicken salad with mixed greens, avocado and light vinaigrette dressing.",
                    "Baked salmon with steamed broccoli and quinoa for a balanced dinner.",
                    "Overnight oats with almond milk, chia seeds and fresh fruit for a quick breakfast.",
                    "Turkey and vegetable stir-fry with brown rice, seasoned with low-sodium soy sauce.",
                    "Lentil soup with a side of whole grain bread for a filling lunch option.",
                    "Egg white omelet with spinach, tomatoes and a small amount of feta cheese.",
                    "Chicken vegetable soup with a side of mixed green salad.",
                    "Tuna salad (made with Greek yogurt instead of mayo) on whole grain toast.",
                    "Smoothie bowl with spinach, banana, berries, and a tablespoon of almond butter."
                ];
                
                // Get random suggestion
                return mealSuggestions[Math.floor(Math.random() * mealSuggestions.length)];
            }
            
            // Generate exercise suggestion based on user data
            function generateExerciseSuggestion(profile, weightData) {
                const exerciseSuggestions = [
                    "Try a 30-minute brisk walk today. It can burn up to 150 calories while being gentle on your joints.",
                    "Consider adding 15 minutes of bodyweight exercises like pushups, squats, and lunges to your routine.",
                    "Swimming is great low-impact exercise that works your entire body while being easy on joints.",
                    "A 20-minute HIIT workout can be more effective than 45 minutes of steady cardio for fat burning.",
                    "Try a cycling class or bike ride - it's excellent cardio that's easier on your knees than running.",
                    "Strength training helps build muscle, which burns more calories even when you're resting.",
                    "Yoga can help with flexibility, stress reduction, and mindful eating habits.",
                    "Dancing is a fun way to burn calories without feeling like you're exercising.",
                    "Try taking the stairs instead of elevators, and parking further from entrances for extra daily steps.",
                    "Consider a walking meeting or phone call - movement while working can add exercise to your day."
                ];
                
                // Get random suggestion
                return exerciseSuggestions[Math.floor(Math.random() * exerciseSuggestions.length)];
            }
            
            // Generate motivation based on user progress
            function generateMotivationSuggestion(weightData) {
                const motivationSuggestions = [
                    "Remember that consistency beats perfection. Small daily choices add up to big results over time.",
                    "You're not just losing weight, you're gaining health, energy, and confidence with every step.",
                    "Progress isn't always linear - focus on your overall trend rather than day-to-day fluctuations.",
                    "Every time you choose health, you're voting for your future self. That's something to be proud of!",
                    "Your weight loss journey is teaching you discipline and self-care that will benefit all areas of your life.",
                    "Don't compare your chapter 1 to someone else's chapter 20. Your journey is uniquely yours.",
                    "Success isn't about perfect days, it's about never giving up after imperfect ones.",
                    "The fact that you're trying puts you ahead of everyone still sitting on the couch. Keep going!",
                    "Think of each healthy choice as a gift to your future self. Future you will be so grateful.",
                    "Remember your 'why' - the deeper reason you started this journey will help keep you motivated."
                ];
                
                // Get random suggestion
                return motivationSuggestions[Math.floor(Math.random() * motivationSuggestions.length)];
            }
            
            // Generate progress insight based on weight data
            function generateProgressInsight() {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser) return "I don't have enough data to analyze your progress yet.";
                
                const weightDataKey = `weight_history_${currentUser.email}`;
                const weightData = getFromStorage(weightDataKey, []);
                
                if (!Array.isArray(weightData) || weightData.length < 2) {
                    return "I'll need more weight entries to provide meaningful insights about your progress.";
                }
                
                // Sort by date (oldest first)
                const sortedData = [...weightData].sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });
                
                const oldestEntry = sortedData[0];
                const latestEntry = sortedData[sortedData.length - 1];
                const totalChange = latestEntry.weight - oldestEntry.weight;
                const timeSpan = Math.ceil((new Date(latestEntry.date) - new Date(oldestEntry.date)) / (1000 * 60 * 60 * 24));
                
                if (totalChange < 0) {
                    return `You've lost ${Math.abs(totalChange).toFixed(1)} ${oldestEntry.weightUnit || 'kg'} over ${timeSpan} days. That's an average of ${(Math.abs(totalChange) / (timeSpan / 7)).toFixed(2)} ${oldestEntry.weightUnit || 'kg'} per week. Great progress!`;
                } else if (totalChange > 0) {
                    return `Your weight has increased by ${totalChange.toFixed(1)} ${oldestEntry.weightUnit || 'kg'} over ${timeSpan} days. Let's work on strategies to help you get back on track!`;
                } else {
                    return `Your weight has remained stable over the past ${timeSpan} days. If you're looking to lose weight, we might need to adjust your calorie intake or exercise routine.`;
                }
            }
        }
        
        // Get daily calorie data with better error handling
        function getDailyCalorieData() {
            try {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return Array(7).fill(0);
                
                const userKey = `planner_${currentUser.email}`;
                
                // Get weekly calories and exercise with validation
                let weeklyCalories, weeklyExercise;
                
                try {
                    weeklyCalories = JSON.parse(localStorage.getItem(`${userKey}_calories`)) || [0, 0, 0, 0, 0, 0, 0];
                    if (!Array.isArray(weeklyCalories) || weeklyCalories.length !== 7) {
                        weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
                    }
                } catch (e) {
                    weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
                }
                
                try {
                    weeklyExercise = JSON.parse(localStorage.getItem(`${userKey}_exercise`)) || [0, 0, 0, 0, 0, 0, 0];
                    if (!Array.isArray(weeklyExercise) || weeklyExercise.length !== 7) {
                        weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
                    }
                } catch (e) {
                    weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
                }
                
                // Get foods to determine actual intake patterns (breakfast, lunch, dinner, snacks)
                let foods = [];
                try {
                    foods = JSON.parse(localStorage.getItem(`${userKey}_foods`)) || [[], [], [], [], [], [], []];
                    if (!Array.isArray(foods) || foods.length !== 7) {
                        foods = [[], [], [], [], [], [], []];
                    }
                } catch (e) {
                    foods = [[], [], [], [], [], [], []];
                }
                
                // Calculate only intake calories (no exercise subtraction)
                const dailyCalories = weeklyCalories.map(cal => parseFloat(cal) || 0);
                
                // If all zeros, use simulated data based on profile
                if (dailyCalories.every(cal => cal === 0)) {
                    const profileKey = `profile_${currentUser.email}`;
                    const profile = getFromStorage(profileKey);
                    const targetCalories = parseFloat(profile?.dailyGoal) || 2000;
                    
                    // Create more realistic simulated data with a weekly pattern
                    return [
                        Math.round(targetCalories * 0.95), // Monday - slightly under
                        Math.round(targetCalories * 0.98), // Tuesday
                        Math.round(targetCalories * 1.05), // Wednesday - slightly over
                        Math.round(targetCalories * 0.97), // Thursday
                        Math.round(targetCalories * 1.15), // Friday - weekend starting
                        Math.round(targetCalories * 1.25), // Saturday - weekend
                        Math.round(targetCalories * 1.1)   // Sunday - weekend ending
                    ];
                }
                
                return dailyCalories;
            } catch (error) {
                console.error('Error getting calorie data:', error);
                return Array(7).fill(0);
            }
        }
        
        // Get daily exercise data
        function getDailyExerciseData() {
            try {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return Array(7).fill(0);
                
                const userKey = `planner_${currentUser.email}`;
                
                // Get weekly exercise with validation
                let weeklyExercise;
                
                try {
                    weeklyExercise = JSON.parse(localStorage.getItem(`${userKey}_exercise`)) || [0, 0, 0, 0, 0, 0, 0];
                    if (!Array.isArray(weeklyExercise) || weeklyExercise.length !== 7) {
                        weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
                    }
                } catch (e) {
                    weeklyExercise = [0, 0, 0, 0, 0, 0, 0];
                }
                
                // Map to numbers
                const dailyExercise = weeklyExercise.map(ex => parseFloat(ex) || 0);
                
                // If all zeros, create simulated data
                if (dailyExercise.every(ex => ex === 0)) {
                    // Create realistic workout pattern - more on weekends, rest days
                    return [
                        200, // Monday - light workout
                        0,   // Tuesday - rest day
                        300, // Wednesday - medium workout
                        0,   // Thursday - rest day
                        250, // Friday - light workout
                        450, // Saturday - heavy workout
                        200  // Sunday - light workout
                    ];
                }
                
                return dailyExercise;
            } catch (error) {
                console.error('Error getting exercise data:', error);
                return Array(7).fill(0);
            }
        }
        
        // Calculate average daily calories for the past month
        function getAverageCalorieData() {
            try {
                const currentUser = getFromStorage('currentUser');
                if (!currentUser || !currentUser.email) return { days: [], calories: [] };
                
                const userKey = `planner_${currentUser.email}`;
                
                // Get current weekly data
                let weeklyCalories;
                try {
                    weeklyCalories = JSON.parse(localStorage.getItem(`${userKey}_calories`)) || [0, 0, 0, 0, 0, 0, 0];
                    if (!Array.isArray(weeklyCalories) || weeklyCalories.length !== 7) {
                        weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
                    }
                } catch (e) {
                    weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
                }
                
                // Create 4-week historical data with trend
                const profileKey = `profile_${currentUser.email}`;
                const profile = getFromStorage(profileKey);
                const dailyGoal = parseFloat(profile?.dailyGoal) || 2000;
                
                // Generate 4 weeks of data with a generally improving trend
                const fourWeeksData = [];
                
                // Start with higher values (over target) and gradually improve
                for (let week = 0; week < 4; week++) {
                    // Calculate adjustment factor - starts higher and gradually improves
                    const weekFactor = 1.2 - (week * 0.05); // 1.2, 1.15, 1.1, 1.05
                    
                    // Use current week's data for the latest week
                    if (week === 3) {
                        fourWeeksData.push(...weeklyCalories);
                    } else {
                        // Create simulated data for previous weeks
                        for (let day = 0; day < 7; day++) {
                            // Random daily fluctuation
                            const randomFactor = 0.9 + (Math.random() * 0.2); // 0.9 to 1.1
                            const calories = Math.round(dailyGoal * weekFactor * randomFactor);
                            fourWeeksData.push(calories);
                        }
                    }
                }
                
                // Calculate 7-day moving average
                const movingAverages = [];
                for (let i = 6; i < fourWeeksData.length; i++) {
                    const weekSum = fourWeeksData.slice(i-6, i+1).reduce((sum, cal) => sum + cal, 0);
                    movingAverages.push(Math.round(weekSum / 7));
                }
                
                // Create date labels for the past 4 weeks
                const dateLabels = [];
                const today = new Date();
                for (let i = 0; i < movingAverages.length; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - (movingAverages.length - 1 - i));
                    dateLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                
                return {
                    days: dateLabels,
                    calories: movingAverages
                };
            } catch (error) {
                console.error('Error calculating average calories:', error);
                return { days: [], calories: [] };
            }
        }
        
        // Initialize charts
        function initializeCharts(profile) {
            // Weight trend chart
            const weightDataSet = getWeeklyWeightData();
            const weightData = weightDataSet.map(entry => entry.weight);
            const weightDates = weightDataSet.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Daily calorie and exercise data
            const calorieData = getDailyCalorieData();
            const exerciseData = getDailyExerciseData();
            
            // Average calorie data
            const avgCalorieData = getAverageCalorieData();
            
            // Get day labels for the week
            const today = new Date();
            const weekLabels = Array(7).fill().map((_, i) => {
                const day = new Date(today);
                day.setDate(day.getDate() - 6 + i);
                return day.toLocaleDateString('en-US', { weekday: 'short' });
            });
            
            // Weight chart
            const weightChart = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: weightDates,
                    datasets: [{
                        label: 'Weight',
                        data: weightData,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Goal Weight',
                        data: Array(weightData.length).fill(parseFloat(profile.goalWeight) || (Math.min(...weightData) - 1)),
                        borderColor: '#FF9800',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: profile.weightUnit || 'kg'
                            },
                            min: Math.floor(Math.min(...weightData, parseFloat(profile.goalWeight) || 0) - 1),
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Goal Weight') {
                                        return `Goal: ${context.raw} ${profile.weightUnit || 'kg'}`;
                                    }
                                    return `Weight: ${context.raw} ${profile.weightUnit || 'kg'}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        }
                    }
                }
            });
            
            // Daily calorie chart
            const calorieChart = new Chart(document.getElementById('calorieChart'), {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: 'Calories In',
                        data: calorieData,
                        backgroundColor: '#FF5722',
                        borderColor: '#E64A19',
                        borderWidth: 1,
                        order: 2
                    }, {
                        label: 'Exercise',
                        data: exerciseData,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1,
                        order: 1
                    }, {
                        label: 'Daily Target',
                        data: Array(7).fill(parseFloat(profile.dailyGoal) || 2000),
                        type: 'line',
                        borderColor: '#2196F3',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false,
                        order: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            display: true,
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Calories (kcal)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' kcal';
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        }
                    }
                }
            });
            
            // Average calorie trend chart
            const avgCalorieChart = new Chart(document.getElementById('avgCalorieChart'), {
                type: 'line',
                data: {
                    labels: avgCalorieData.days,
                    datasets: [{
                        label: '7-Day Average Intake',
                        data: avgCalorieData.calories,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.2)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Target',
                        data: Array(avgCalorieData.days.length).fill(parseFloat(profile.dailyGoal) || 2000),
                        borderColor: '#2196F3',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Calories (kcal)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Target') {
                                        return `Target: ${context.raw} kcal`;
                                    }
                                    return `Average: ${context.raw} kcal`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        }
                    }
                }
            });
            
            // Exercise chart
            const exerciseChart = new Chart(document.getElementById('exerciseChart'), {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: 'Calories Burned',
                        data: exerciseData,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1
                    }, {
                        label: 'Weekly Average',
                        data: Array(7).fill(exerciseData.reduce((sum, val) => sum + val, 0) / 7),
                        type: 'line',
                        borderColor: '#7B1FA2',
                        backgroundColor: 'rgba(123, 31, 162, 0.2)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            display: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Calories Burned (kcal)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' kcal';
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        }
                    }
                }
            });
            
            // Store charts for updating
            window.weightChart = weightChart;
            window.calorieChart = calorieChart;
            window.avgCalorieChart = avgCalorieChart;
            window.exerciseChart = exerciseChart;
        }
        
        // Update charts based on selected view
        function updateCharts(view) {
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            const profileKey = `profile_${currentUser.email}`;
            const profile = getFromStorage(profileKey);
            if (!profile) return;
            
            // Get goal weight
            const goalWeight = parseFloat(profile.goalWeight) || 0;
            
            if (view === 'monthly') {
                // Update weight chart to show monthly projection
                if (window.weightChart) {
                    // Get current weight data
                    const weightDataSet = getWeeklyWeightData();
                    let weightData = weightDataSet.map(entry => entry.weight);
                    let weightDates = weightDataSet.map(entry => {
                        const date = new Date(entry.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    
                    // Add projected future data
                    const lastWeight = weightData[weightData.length - 1];
                    const today = new Date();
                    
                    // Create projection for next 8 weeks
                    for (let i = 1; i <= 8; i++) {
                        // Calculate projected weight with decreasing rate of loss
                        const weeklyLoss = 0.5 * Math.max(0.5, 1 - (i * 0.05)); // Diminishing loss rate
                        const projectedWeight = Math.max(goalWeight, lastWeight - (weeklyLoss * i));
                        
                        // Add to data arrays
                        weightData.push(Number(projectedWeight.toFixed(1)));
                        
                        // Create projected date
                        const futureDate = new Date(today);
                        futureDate.setDate(today.getDate() + (i * 7));
                        weightDates.push(futureDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    }
                    
                    // Update chart data
                    window.weightChart.data.labels = weightDates;
                    window.weightChart.data.datasets[0].data = weightData;
                    window.weightChart.data.datasets[1].data = Array(weightData.length).fill(goalWeight);
                    window.weightChart.options.scales.y.min = Math.floor(Math.min(...weightData, goalWeight) - 1);
                    window.weightChart.update();
                }
                
                // Update average calorie chart to show longer trend
                if (window.avgCalorieChart) {
                    const avgCalorieData = getAverageCalorieData();
                    window.avgCalorieChart.data.labels = avgCalorieData.days;
                    window.avgCalorieChart.data.datasets[0].data = avgCalorieData.calories;
                    window.avgCalorieChart.data.datasets[1].data = Array(avgCalorieData.days.length).fill(parseFloat(profile.dailyGoal) || 2000);
                    window.avgCalorieChart.update();
                }
            } else { // Weekly view
                // Update to show weekly data
                if (window.weightChart) {
                    const weightDataSet = getWeeklyWeightData();
                    const weightData = weightDataSet.map(entry => entry.weight);
                    const weightDates = weightDataSet.map(entry => {
                        const date = new Date(entry.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    
                    window.weightChart.data.labels = weightDates;
                    window.weightChart.data.datasets[0].data = weightData;
                    window.weightChart.data.datasets[1].data = Array(weightData.length).fill(goalWeight);
                    window.weightChart.options.scales.y.min = Math.floor(Math.min(...weightData, goalWeight) - 1);
                    window.weightChart.update();
                }
                
                // Update daily charts
                if (window.calorieChart) {
                    const calorieData = getDailyCalorieData();
                    const exerciseData = getDailyExerciseData();
                    
                    // Get day labels for the week
                    const today = new Date();
                    const weekLabels = Array(7).fill().map((_, i) => {
                        const day = new Date(today);
                        day.setDate(day.getDate() - 6 + i);
                        return day.toLocaleDateString('en-US', { weekday: 'short' });
                    });
                    
                    window.calorieChart.data.labels = weekLabels;
                    window.calorieChart.data.datasets[0].data = calorieData;
                    window.calorieChart.data.datasets[1].data = exerciseData;
                    window.calorieChart.data.datasets[2].data = Array(7).fill(parseFloat(profile.dailyGoal) || 2000);
                    window.calorieChart.update();
                    
                    if (window.exerciseChart) {
                        window.exerciseChart.data.labels = weekLabels;
                        window.exerciseChart.data.datasets[0].data = exerciseData;
                        const avgExercise = exerciseData.reduce((sum, val) => sum + val, 0) / 7;
                        window.exerciseChart.data.datasets[1].data = Array(7).fill(avgExercise);
                        window.exerciseChart.update();
                    }
                }
            }
        }
        
        /**
         * Initialize quick add food buttons
         * @param {Date} date - Current date
         */
        function initializeQuickAdd(date) {
            const quickAddButtons = document.querySelectorAll('.quick-add-btn');
            if (!quickAddButtons.length) return;
            
            // Create formatted date string for display
            const dateString = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short', 
                day: 'numeric'
            });
            
            // Get day index for storage
            const day = date.getDay(); // 0 = Sunday
            const dayIndex = day === 0 ? 6 : day - 1; // Convert to 0 = Monday
            
            // Add event listeners to all quick add buttons
            quickAddButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const calories = parseInt(this.dataset.calories);
                    const foodName = this.dataset.name;
                    
                    // Add to tracker storage for the specific day
                    addFoodToTracker(dayIndex, foodName, calories);
                    
                    // Show notification with date
                    showNotification(`Added ${foodName} (${calories} kcal) to ${dateString}'s log`, 'success');
                    
                    // Update stats display
                    const currentUser = getFromStorage('currentUser');
                    if (!currentUser) return;
                    
                    const profileKey = `profile_${currentUser.email}`;
                    const profile = getFromStorage(profileKey);
                    if (profile) {
                        initializeStats(profile, date);
                    }
                });
            });
        }
        
        /**
         * Add food to tracker storage for a specific day
         * @param {number} dayIndex - Day index (0-6, Monday-Sunday)
         * @param {string} foodName - Name of the food
         * @param {number} calories - Calorie amount
         */
        function addFoodToTracker(dayIndex, foodName, calories) {
            // Validate inputs
            if (dayIndex < 0 || dayIndex > 6 || !foodName || isNaN(calories)) {
                console.error('Invalid input for addFoodToTracker:', { dayIndex, foodName, calories });
                return;
            }
            
            // Get current user
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            const userKey = `planner_${currentUser.email}`;
            
            // Get existing data with fallbacks
            let weeklyCalories;
            try {
                weeklyCalories = JSON.parse(localStorage.getItem(`${userKey}_calories`)) || [0, 0, 0, 0, 0, 0, 0];
            } catch (e) {
                console.error('Error parsing calories:', e);
                weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
            }
            
            let weeklyFoods;
            try {
                weeklyFoods = JSON.parse(localStorage.getItem(`${userKey}_foods`)) || [[], [], [], [], [], [], []];
            } catch (e) {
                console.error('Error parsing foods:', e);
                weeklyFoods = [[], [], [], [], [], [], []];
            }
            
            // Ensure arrays have the correct length
            if (!Array.isArray(weeklyCalories) || weeklyCalories.length !== 7) weeklyCalories = [0, 0, 0, 0, 0, 0, 0];
            if (!Array.isArray(weeklyFoods) || weeklyFoods.length !== 7) weeklyFoods = [[], [], [], [], [], [], []];
            
            // Add food
            weeklyCalories[dayIndex] = (parseFloat(weeklyCalories[dayIndex]) || 0) + calories;
            weeklyFoods[dayIndex].push({
                text: `${foodName} (${calories} kcal)`,
                cal: calories,
                type: 'snack', // Default to snack for quick adds
                date: new Date().toISOString() // Add timestamp for sorting
            });
            
            // Save back to storage
            localStorage.setItem(`${userKey}_calories`, JSON.stringify(weeklyCalories));
            localStorage.setItem(`${userKey}_foods`, JSON.stringify(weeklyFoods));
            
            console.log('Food added to tracker:', { 
                dayIndex, 
                foodName, 
                calories, 
                totalCalories: weeklyCalories[dayIndex] 
            });
        }
        
        // Show notification
        function showNotification(message) {
            // Check if notification container exists
            let notificationContainer = document.getElementById('notification-container');
            
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.position = 'fixed';
                notificationContainer.style.bottom = '20px';
                notificationContainer.style.right = '20px';
                notificationContainer.style.zIndex = '1000';
                document.body.appendChild(notificationContainer);
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.style.backgroundColor = 'var(--success-color)';
            notification.style.color = 'white';
            notification.style.padding = '15px';
            notification.style.margin = '10px';
            notification.style.borderRadius = 'var(--border-radius)';
            notification.style.boxShadow = 'var(--card-shadow)';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.transition = 'all 0.3s';
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            
            notification.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 10px;"></i> ${message}`;
            
            // Add to container
            notificationContainer.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 50);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    notificationContainer.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Load daily tip and motivational quote
        function loadDailyTip() {
            const tips = [
                "Stay consistent with your tracking. Research shows that people who log their food regularly lose more weight and keep it off longer.",
                "Don't forget to drink water! Often thirst can be mistaken for hunger.",
                "Focus on progress, not perfection. Small, consistent changes lead to lasting results.",
                "Include protein with each meal to help you feel fuller longer.",
                "Plan your meals ahead of time to avoid last-minute unhealthy choices.",
                "Get enough sleep! Poor sleep is linked to increased appetite and cravings.",
                "A 10-minute walk after meals can help digestion and stabilize blood sugar.",
                "Eating slowly and mindfully helps you recognize when you're full.",
                "Focus on nutrient-dense foods rather than just calorie counting.",
                "Celebrate non-scale victories like increased energy and better-fitting clothes.",
                "Incorporate strength training to boost your metabolism.",
                "Remember that weight fluctuates naturally day to day.",
                "Prepping healthy snacks can help you avoid vending machines and drive-thrus.",
                "Find physical activities you enjoy rather than exercises you dread."
            ];
            
            const quotes = [
                "Success is the sum of small efforts, repeated day in and day out.",
                "The only bad workout is the one that didn't happen.",
                "Weight loss is a journey, not a destination.",
                "It's not about being perfect. It's about being better than you were yesterday.",
                "The hardest step is the first one out the door.",
                "It's not about having time, it's about making time.",
                "Good things come to those who sweat.",
                "Fall in love with taking care of yourself. Mind. Body. Spirit.",
                "Make yourself a priority once in a while. It's not selfish. It's necessary.",
                "Your body hears everything your mind says. Stay positive.",
                "The scale can only give you a numerical reflection of your relationship with gravity. That's it.",
                "You don't have to be extreme, just consistent.",
                "Strive for progress, not perfection.",
                "Exercise is a celebration of what your body can do, not a punishment for what you ate."
            ];
            
            // Get date-based index to keep content consistent for the whole day
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (24 * 60 * 60 * 1000));
            const tipIndex = dayOfYear % tips.length;
            const quoteIndex = (dayOfYear + 3) % quotes.length; // Offset to show different quote than tip
            
            // Set daily tip
            const dailyTipElement = document.getElementById('dailyTip');
            if (dailyTipElement) {
                dailyTipElement.textContent = tips[tipIndex];
            }
            
            // Set motivational quote
            const quoteTextElement = document.getElementById('quoteText');
            if (quoteTextElement) {
                quoteTextElement.textContent = quotes[quoteIndex];
            }
        }
        
        // Theme Toggle Functionality
        function setupThemeToggle() {
            const lightThemeBtn = document.getElementById('lightTheme');
            const darkThemeBtn = document.getElementById('darkTheme');
            
            if (!lightThemeBtn || !darkThemeBtn) return;
            
            // Load user preference
            const userTheme = localStorage.getItem('slimEasyTheme') || 'light';
            
            // Set initial state
            if (userTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                lightThemeBtn.classList.remove('active');
                darkThemeBtn.classList.add('active');
            } else {
                document.documentElement.removeAttribute('data-theme');
                lightThemeBtn.classList.add('active');
                darkThemeBtn.classList.remove('active');
            }
            
            // Light theme button
            lightThemeBtn.addEventListener('click', function() {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('slimEasyTheme', 'light');
                lightThemeBtn.classList.add('active');
                darkThemeBtn.classList.remove('active');
                
                // Redraw charts with light theme
                if (window.weightChart) window.weightChart.update();
                if (window.calorieChart) window.calorieChart.update();
                if (window.avgCalorieChart) window.avgCalorieChart.update();
                if (window.exerciseChart) window.exerciseChart.update();
            });
            
            // Dark theme button
            darkThemeBtn.addEventListener('click', function() {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('slimEasyTheme', 'dark');
                lightThemeBtn.classList.remove('active');
                darkThemeBtn.classList.add('active');
                
                // Redraw charts with dark theme
                if (window.weightChart) window.weightChart.update();
                if (window.calorieChart) window.calorieChart.update();
                if (window.avgCalorieChart) window.avgCalorieChart.update();
                if (window.exerciseChart) window.exerciseChart.update();
            });
        }
    </script>
    <style>
        /* Dashboard welcome section */
        .dashboard-welcome {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .welcome-left {
            flex: 1;
            min-width: 250px;
        }
        
        .welcome-left h1 {
            margin-bottom: 5px;
        }
        
        .welcome-left #welcomeMessage {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .welcome-right {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .dashboard-date {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Theme toggle */
        .theme-toggle {
            display: flex;
            background: var(--card-bg);
            border-radius: 30px;
            padding: 5px;
            box-shadow: var(--card-shadow);
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .theme-btn:hover:not(.active) {
            background: rgba(0,0,0,0.05);
        }
        
        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: var(--card-bg);
            border-radius: 30px;
            padding: 5px;
            box-shadow: var(--card-shadow);
        }
        
        .view-toggle .action-button {
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 14px;
            background: transparent;
            color: var(--text-primary);
            border: none;
        }
        
        .action-button.active-view {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Motivational quote */
        .motivational-quote {
            background: linear-gradient(120deg, var(--primary-light), var(--primary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-style: italic;
            font-size: 18px;
            position: relative;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .motivational-quote i.fa-quote-left {
            position: absolute;
            left: 15px;
            top: 15px;
            font-size: 24px;
            opacity: 0.5;
        }
        
        .motivational-quote i.fa-quote-right {
            position: absolute;
            right: 15px;
            bottom: 15px;
            font-size: 24px;
            opacity: 0.5;
        }
        
        .water-tracker {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        #waterGlasses {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        #waterStatus {
            margin-top: 5px;
            color: var(--progress-water);
            font-weight: 500;
        }
        
        /* Chart styling */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 10px 0;
        }
        
        canvas {
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            border-radius: 5px;
            background-color: rgba(255,255,255,0.7);
        }
        
        @media (max-width: 768px) {
            .water-tracker {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
        }
        
        /* Weekly weight tracking styles */
        .weight-history {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .weight-entries {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .weight-entry {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        .weight-entry-date {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .weight-entry-value {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .delete-entry-btn {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s, background-color 0.2s;
        }
        
        .delete-entry-btn:hover {
            opacity: 1;
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        .start-weight-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        /* AI Buddy Modal Styles */
        .ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .ai-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .ai-modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            max-width: 90%;
            width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .ai-modal.show .ai-modal-content {
            transform: translateY(0);
        }
        
        .ai-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--divider-color);
        }
        
        .ai-modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
        }
        
        .ai-modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .ai-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .ai-chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-message {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .ai-message.user {
            background-color: var(--primary-light);
            color: var(--text-primary);
            align-self: flex-end;
        }
        
        .ai-message.buddy {
            background-color: var(--accent-light);
            color: var(--text-primary);
            align-self: flex-start;
        }
        
        .ai-suggestion {
            background-color: var(--card-bg);
            border: 1px solid var(--divider-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .ai-suggestion:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .ai-suggestion-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .ai-suggestion-content {
            margin-bottom: 10px;
        }
        
        .ai-suggestion-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        
        .ai-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--divider-color);
            display: flex;
            gap: 10px;
        }
        
        .ai-modal-footer input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--divider-color);
            border-radius: 20px;
            background-color: var(--background-main);
            color: var(--text-primary);
        }
        
        .ai-modal-footer button {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ai-modal-footer button:hover {
            background-color: var(--primary-dark);
        }
        
        .ai-typing {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            font-style: italic;
            color: var(--text-secondary);
        }
        
        .ai-dot {
            width: 6px;
            height: 6px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: ai-typing 1.4s infinite;
            display: inline-block;
        }
        
        .ai-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .ai-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes ai-typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.6;
            }
            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
    </style>
    
    <!-- AI Buddy Modal -->
    <div class="ai-modal" id="aiBuddyModal">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3><i class="fas fa-robot"></i> SlimEasy AI Buddy</h3>
                <button class="ai-modal-close" id="aiBuddyClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-message buddy">
                        Hello! I'm your SlimEasy AI Buddy. I can provide personalized meal suggestions, 
                        exercise tips, and motivation based on your profile and progress data. 
                        How can I help you today?
                    </div>
                </div>
                <div class="ai-typing" id="aiTyping" style="display: none;">
                    <span class="ai-dot"></span>
                    <span class="ai-dot"></span>
                    <span class="ai-dot"></span>
                </div>
            </div>
            <div class="ai-modal-footer">
                <input type="text" id="aiMessageInput" placeholder="Ask something..." autocomplete="off">
                <button id="aiSendBtn">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>
</body>
</html>