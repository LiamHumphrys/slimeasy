<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SlimEasy - Track your progress over time with calendar view">
    <meta name="theme-color" content="#4CAF50">
    <title>SlimEasy - Calendar View</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Preload critical assets -->
    <link rel="preload" href="theme.js" as="script">
    <link rel="preload" href="utils.js" as="script">
    <link rel="preload" href="slimeasylogo.jpg" as="image">
    <link rel="stylesheet" href="footer.css">
    <!-- Favicon -->
    <link rel="icon" href="slimeasylogo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="slimeasylogo.jpg">
</head>
<body>
    <!-- Main Navigation -->
    <nav class="main-nav">
        <div class="main-nav-container">
            <a href="index.html" class="main-nav-logo">
                <img src="slimeasylogo.jpg" alt="SlimEasy">
                <span>SlimEasy</span>
            </a>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="main-nav-links" id="mainNavLinks">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="tracker.html" class="nav-link">
                    <i class="fas fa-utensils"></i> Food Tracker
                </a>
                <a href="exercise.html" class="nav-link">
                    <i class="fas fa-running"></i> Exercise
                </a>
                <a href="calendar.html" class="nav-link active">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </a>
                <a href="wearable-settings.html" class="nav-link">
                    <i class="fas fa-sync"></i> Wearables
                </a>
                <a href="community.html" class="nav-link">
                    <i class="fas fa-users"></i> Community
                </a>
                <a href="contact.html" class="nav-link">
                    <i class="fas fa-envelope"></i> Contact Us
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1><i class="fas fa-calendar-alt"></i> Progress Calendar</h1>
        <p id="welcomeMessage"></p>
        
        <!-- View Controls -->
        <div class="view-controls">
            <div class="date-navigation">
                <button id="prevPeriod" class="nav-button">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="current-period" id="currentPeriod">May 2025</div>
                <button id="nextPeriod" class="nav-button">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="view-type">
                <button class="view-button active" data-view="month" id="monthView">Month</button>
                <button class="view-button" data-view="week" id="weekView">Week</button>
            </div>
        </div>
        
        <!-- Calendar View -->
        <div class="calendar-container" id="calendarMonth">
            <div class="calendar-header">
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
                <div>Sun</div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Will be filled by JavaScript -->
            </div>
        </div>
        
        <!-- Week View -->
        <div class="week-container" id="calendarWeek" style="display: none;">
            <div class="week-header" id="weekHeader">
                <!-- Will be filled by JavaScript -->
            </div>
            <div class="week-grid" id="weekGrid">
                <!-- Will be filled by JavaScript -->
            </div>
        </div>
        
        <!-- Day Detail Modal -->
        <div class="calendar-modal" id="dayDetailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalDate">May 15, 2025</h2>
                    <button class="modal-close" id="modalClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="day-summary">
                        <div class="summary-item">
                            <i class="fas fa-weight"></i>
                            <div>
                                <h3>Weight</h3>
                                <p id="modalWeight">Not recorded</p>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-fire"></i>
                            <div>
                                <h3>Calories</h3>
                                <p id="modalCalories">Not recorded</p>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-running"></i>
                            <div>
                                <h3>Exercise</h3>
                                <p id="modalExercise">Not recorded</p>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-tint"></i>
                            <div>
                                <h3>Water</h3>
                                <p id="modalWater">Not recorded</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-macros">
                        <h3>Macronutrients</h3>
                        <div class="macro-rings">
                            <div class="macro-ring">
                                <svg width="80" height="80" class="ring">
                                    <circle cx="40" cy="40" r="35" class="ring-bg"></circle>
                                    <circle cx="40" cy="40" r="35" class="ring-fg protein-ring" id="proteinRing"></circle>
                                    <text x="40" y="40" text-anchor="middle" dominant-baseline="middle" class="ring-text" id="proteinPercent">0%</text>
                                </svg>
                                <p>Protein</p>
                            </div>
                            <div class="macro-ring">
                                <svg width="80" height="80" class="ring">
                                    <circle cx="40" cy="40" r="35" class="ring-bg"></circle>
                                    <circle cx="40" cy="40" r="35" class="ring-fg carbs-ring" id="carbsRing"></circle>
                                    <text x="40" y="40" text-anchor="middle" dominant-baseline="middle" class="ring-text" id="carbsPercent">0%</text>
                                </svg>
                                <p>Carbs</p>
                            </div>
                            <div class="macro-ring">
                                <svg width="80" height="80" class="ring">
                                    <circle cx="40" cy="40" r="35" class="ring-bg"></circle>
                                    <circle cx="40" cy="40" r="35" class="ring-fg fat-ring" id="fatRing"></circle>
                                    <text x="40" y="40" text-anchor="middle" dominant-baseline="middle" class="ring-text" id="fatPercent">0%</text>
                                </svg>
                                <p>Fat</p>
                            </div>
                        </div>
                        <div class="macro-details">
                            <div><span class="macro-label protein">Protein:</span> <span id="proteinGrams">0g</span></div>
                            <div><span class="macro-label carbs">Carbs:</span> <span id="carbsGrams">0g</span></div>
                            <div><span class="macro-label fat">Fat:</span> <span id="fatGrams">0g</span></div>
                        </div>
                    </div>
                    
                    <div class="food-list">
                        <h3>Food Log</h3>
                        <ul id="foodList">
                            <!-- Will be filled by JavaScript -->
                        </ul>
                    </div>
                    
                    <div class="exercise-list">
                        <h3>Exercise Log</h3>
                        <ul id="exerciseList">
                            <!-- Will be filled by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Privacy Policy -->
    <footer class="app-footer">
        <div class="footer-content">
            <p>&copy; 2025 SlimEasy | <a href="privacy-policy.html" class="privacy-link">Privacy Policy</a></p>
        </div>
    </footer>
    
    <script src="theme.js"></script>
    <script src="utils.js"></script>
    <script>
        // Initialize when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize page (theme, menu, login check)
            if (initializePage()) {
                // Initialize calendar view
                initializeCalendar();
                
                // Register service worker
                registerServiceWorker();
            }
        });
        
        // Current view state
        let currentDate = new Date();
        let currentView = 'month';
        let calendarData = {};
        
        /**
         * Initialize calendar components
         */
        function initializeCalendar() {
            // Set up view type buttons
            document.getElementById('monthView').addEventListener('click', function() {
                setCalendarView('month');
            });
            
            document.getElementById('weekView').addEventListener('click', function() {
                setCalendarView('week');
            });
            
            // Set up navigation buttons
            document.getElementById('prevPeriod').addEventListener('click', function() {
                navigateCalendar('prev');
            });
            
            document.getElementById('nextPeriod').addEventListener('click', function() {
                navigateCalendar('next');
            });
            
            // Set up modal close button
            document.getElementById('modalClose').addEventListener('click', function() {
                document.getElementById('dayDetailModal').classList.remove('show');
            });
            
            // Load initial calendar data
            loadCalendarData();
            
            // Render initial view
            renderCalendarView();
        }
        
        /**
         * Set calendar view type (month or week)
         * @param {string} viewType - 'month' or 'week'
         */
        function setCalendarView(viewType) {
            currentView = viewType;
            
            // Update active button state
            document.querySelectorAll('.view-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.view-button[data-view="${viewType}"]`).classList.add('active');
            
            // Toggle visibility of views
            if (viewType === 'month') {
                document.getElementById('calendarMonth').style.display = 'block';
                document.getElementById('calendarWeek').style.display = 'none';
            } else {
                document.getElementById('calendarMonth').style.display = 'none';
                document.getElementById('calendarWeek').style.display = 'block';
            }
            
            // Re-render the view
            renderCalendarView();
        }
        
        /**
         * Navigate the calendar (prev/next period)
         * @param {string} direction - 'prev' or 'next'
         */
        function navigateCalendar(direction) {
            if (currentView === 'month') {
                // Navigate by month
                if (direction === 'prev') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            } else {
                // Navigate by week
                const days = direction === 'prev' ? -7 : 7;
                currentDate.setDate(currentDate.getDate() + days);
            }
            
            // Update view
            renderCalendarView();
        }
        
        /**
         * Load data for the calendar view
         */
        function loadCalendarData() {
            const currentUser = getFromStorage('currentUser');
            if (!currentUser) return;
            
            // Initialize empty calendar data
            calendarData = {};
            
            // Load weight data
            const weights = getFromStorage(`weights_${currentUser.email}`, []);
            weights.forEach(entry => {
                const date = entry.date.split('T')[0];
                if (!calendarData[date]) {
                    calendarData[date] = {};
                }
                calendarData[date].weight = entry.weight;
            });
            
            // Load tracked foods by date
            const monthsToLoad = 3; // Load 3 months of data
            const today = new Date();
            
            // Loop through past months to get data
            for (let i = 0; i < monthsToLoad; i++) {
                const date = new Date(today);
                date.setMonth(today.getMonth() - i);
                
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                // Check for food data
                const foodsKey = `foods_${currentUser.email}_${yearMonth}`;
                const monthFoods = getFromStorage(foodsKey, {});
                
                // Process foods into calendar data
                Object.keys(monthFoods).forEach(day => {
                    const dateKey = `${yearMonth}-${day.padStart(2, '0')}`;
                    
                    if (!calendarData[dateKey]) {
                        calendarData[dateKey] = {};
                    }
                    
                    const dayFoods = monthFoods[day];
                    
                    // Calculate total calories and macros
                    let totalCalories = 0;
                    let totalProtein = 0;
                    let totalCarbs = 0;
                    let totalFat = 0;
                    
                    Object.values(dayFoods || {}).forEach(meal => {
                        meal.forEach(food => {
                            totalCalories += food.calories || 0;
                            totalProtein += food.protein || 0;
                            totalCarbs += food.carbs || 0;
                            totalFat += food.fat || 0;
                        });
                    });
                    
                    calendarData[dateKey].calories = totalCalories;
                    calendarData[dateKey].macros = {
                        protein: totalProtein,
                        carbs: totalCarbs,
                        fat: totalFat
                    };
                    calendarData[dateKey].foods = dayFoods;
                });
                
                // Check for exercise data
                const exerciseKey = `exercise_${currentUser.email}_${yearMonth}`;
                const monthExercise = getFromStorage(exerciseKey, {});
                
                // Process exercise into calendar data
                Object.keys(monthExercise).forEach(day => {
                    const dateKey = `${yearMonth}-${day.padStart(2, '0')}`;
                    
                    if (!calendarData[dateKey]) {
                        calendarData[dateKey] = {};
                    }
                    
                    const dayExercises = monthExercise[day];
                    
                    // Check if exercises are organized by time of day (new format)
                    const isTimeBasedFormat = typeof dayExercises === 'object' && 
                        !Array.isArray(dayExercises) &&
                        (dayExercises.morning || dayExercises.afternoon || dayExercises.evening);
                    
                    if (isTimeBasedFormat) {
                        // Time-based format handling
                        const timeSlots = ['morning', 'afternoon', 'evening'];
                        let totalExerciseCalories = 0;
                        let allExercises = [];
                        
                        // Store by time of day
                        calendarData[dateKey].exercisesByTime = {};
                        
                        timeSlots.forEach(timeSlot => {
                            const exercises = dayExercises[timeSlot] || [];
                            
                            if (exercises.length > 0) {
                                calendarData[dateKey].exercisesByTime[timeSlot] = exercises;
                                
                                // Calculate calories and add to flat list
                                exercises.forEach(exercise => {
                                    totalExerciseCalories += exercise.calories || 0;
                                    allExercises.push(exercise);
                                });
                            } else {
                                calendarData[dateKey].exercisesByTime[timeSlot] = [];
                            }
                        });
                        
                        calendarData[dateKey].exercise = totalExerciseCalories;
                        calendarData[dateKey].exercises = allExercises;
                    }
                    // Legacy format handling (array of exercises)
                    else if (Array.isArray(dayExercises)) {
                        // Calculate total exercise calories
                        let totalExerciseCalories = 0;
                        
                        dayExercises.forEach(exercise => {
                            totalExerciseCalories += exercise.calories || 0;
                        });
                        
                        calendarData[dateKey].exercise = totalExerciseCalories;
                        calendarData[dateKey].exercises = dayExercises;
                    }
                });
                
                // Check for water intake data
                for (let day = 1; day <= 31; day++) {
                    const dateKey = `${yearMonth}-${day.toString().padStart(2, '0')}`;
                    const waterKey = `water_${currentUser.email}_${dateKey}`;
                    const waterCount = localStorage.getItem(waterKey);
                    
                    if (waterCount) {
                        if (!calendarData[dateKey]) {
                            calendarData[dateKey] = {};
                        }
                        calendarData[dateKey].water = parseInt(waterCount);
                    }
                }
            }
        }
        
        /**
         * Render the appropriate calendar view
         */
        function renderCalendarView() {
            if (currentView === 'month') {
                renderMonthView();
            } else {
                renderWeekView();
            }
        }
        
        /**
         * Render month view of calendar
         */
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Set header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentPeriod').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Convert to Monday-based
            
            // Get number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Create calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Add blank cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day empty';
                grid.appendChild(cell);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                // Format date for data lookup
                const dateKey = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayData = calendarData[dateKey] || {};
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);
                
                // Today highlight
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }
                
                // Day content
                const dayContent = document.createElement('div');
                dayContent.className = 'day-content';
                
                // Weight indicator
                if (dayData.weight) {
                    const weight = document.createElement('div');
                    weight.className = 'day-indicator weight';
                    weight.innerHTML = `<i class="fas fa-weight"></i> ${dayData.weight.toFixed(1)}`;
                    dayContent.appendChild(weight);
                }
                
                // Calories indicator
                if (dayData.calories) {
                    const calories = document.createElement('div');
                    calories.className = 'day-indicator calories';
                    calories.innerHTML = `<i class="fas fa-fire"></i> ${dayData.calories.toFixed(0)}`;
                    dayContent.appendChild(calories);
                }
                
                // Exercise indicator
                if (dayData.exercise) {
                    const exercise = document.createElement('div');
                    exercise.className = 'day-indicator exercise';
                    exercise.innerHTML = `<i class="fas fa-running"></i> ${dayData.exercise.toFixed(0)}`;
                    dayContent.appendChild(exercise);
                }
                
                // Water indicator
                if (dayData.water) {
                    const water = document.createElement('div');
                    water.className = 'day-indicator water';
                    water.innerHTML = `<i class="fas fa-tint"></i> ${dayData.water}/8`;
                    dayContent.appendChild(water);
                }
                
                cell.appendChild(dayContent);
                
                // Add click event to show day detail
                cell.addEventListener('click', function() {
                    showDayDetail(dateKey);
                });
                
                grid.appendChild(cell);
            }
        }
        
        /**
         * Render week view of calendar
         */
        function renderWeekView() {
            // Get the start of the week (Monday)
            const currentDay = currentDate.getDay();
            const diff = currentDay === 0 ? 6 : currentDay - 1; // Adjust for Monday as first day
            
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - diff);
            
            // Set header with week range
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric' };
            const weekRange = `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', options)}, ${endOfWeek.getFullYear()}`;
            document.getElementById('currentPeriod').textContent = weekRange;
            
            // Create week header
            const header = document.getElementById('weekHeader');
            header.innerHTML = '';
            
            // Create week grid
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            
            // Add days of week
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const isToday = date.getDate() === today.getDate() && 
                              date.getMonth() === today.getMonth() && 
                              date.getFullYear() === today.getFullYear();
                
                // Format date for data lookup
                const dateKey = date.toISOString().split('T')[0];
                const dayData = calendarData[dateKey] || {};
                
                // Format date for display (e.g., "Mon 10/03/25")
                const dayStr = days[i].substring(0, 3);
                const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear().toString().slice(-2)}`;
                
                // Create header day
                const headerDay = document.createElement('div');
                headerDay.className = 'week-day';
                headerDay.innerHTML = `
                    <div class="day-name">${dayStr} ${dateStr}</div>
                    <div class="day-date ${isToday ? 'today' : ''}">${date.getDate()}</div>
                `;
                header.appendChild(headerDay);
                
                // Create day cell
                const dayCell = document.createElement('div');
                dayCell.className = 'week-day-detail';
                if (isToday) dayCell.classList.add('today');
                
                // Weight row
                const weightRow = document.createElement('div');
                weightRow.className = 'detail-row weight';
                weightRow.innerHTML = `
                    <i class="fas fa-weight"></i>
                    <span>${dayData.weight ? dayData.weight.toFixed(1) + ' kg' : '-'}</span>
                `;
                dayCell.appendChild(weightRow);
                
                // Calories row
                const caloriesRow = document.createElement('div');
                caloriesRow.className = 'detail-row calories';
                caloriesRow.innerHTML = `
                    <i class="fas fa-fire"></i>
                    <span>${dayData.calories ? dayData.calories.toFixed(0) + ' kcal' : '-'}</span>
                `;
                dayCell.appendChild(caloriesRow);
                
                // Exercise row
                const exerciseRow = document.createElement('div');
                exerciseRow.className = 'detail-row exercise';
                exerciseRow.innerHTML = `
                    <i class="fas fa-running"></i>
                    <span>${dayData.exercise ? dayData.exercise.toFixed(0) + ' kcal' : '-'}</span>
                `;
                dayCell.appendChild(exerciseRow);
                
                // Water row
                const waterRow = document.createElement('div');
                waterRow.className = 'detail-row water';
                waterRow.innerHTML = `
                    <i class="fas fa-tint"></i>
                    <span>${dayData.water ? dayData.water + '/8 glasses' : '-'}</span>
                `;
                dayCell.appendChild(waterRow);
                
                // Macros row (simplified)
                if (dayData.macros) {
                    const macrosRow = document.createElement('div');
                    macrosRow.className = 'detail-row macros';
                    
                    const protein = dayData.macros.protein || 0;
                    const carbs = dayData.macros.carbs || 0;
                    const fat = dayData.macros.fat || 0;
                    const total = protein + carbs + fat;
                    
                    // Only show if we have macro data
                    if (total > 0) {
                        macrosRow.innerHTML = `
                            <i class="fas fa-chart-pie"></i>
                            <div class="macro-bars">
                                <div class="macro-bar-container">
                                    <div class="macro-bar protein" style="width: ${Math.round(protein/total*100)}%"></div>
                                    <div class="macro-bar carbs" style="width: ${Math.round(carbs/total*100)}%"></div>
                                    <div class="macro-bar fat" style="width: ${Math.round(fat/total*100)}%"></div>
                                </div>
                            </div>
                        `;
                        dayCell.appendChild(macrosRow);
                    }
                }
                
                // Add click event to show day detail
                dayCell.addEventListener('click', function() {
                    showDayDetail(dateKey);
                });
                
                grid.appendChild(dayCell);
            }
        }
        
        /**
         * Show day detail modal
         * @param {string} dateKey - Date in YYYY-MM-DD format
         */
        function showDayDetail(dateKey) {
            const dayData = calendarData[dateKey] || {};
            const date = new Date(dateKey);
            
            // Set modal title
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('modalDate').textContent = date.toLocaleDateString('en-US', options);
            
            // Set weight
            document.getElementById('modalWeight').textContent = dayData.weight 
                ? `${dayData.weight.toFixed(1)} kg (${Math.round(dayData.weight * 2.20462)} lb)` 
                : 'Not recorded';
            
            // Set calories
            document.getElementById('modalCalories').textContent = dayData.calories 
                ? `${dayData.calories.toFixed(0)} kcal${dayData.exercise ? ' / ' + Math.max(0, dayData.calories - dayData.exercise).toFixed(0) + ' net' : ''}` 
                : 'Not recorded';
            
            // Set exercise
            document.getElementById('modalExercise').textContent = dayData.exercise 
                ? `${dayData.exercise.toFixed(0)} kcal burned` 
                : 'Not recorded';
            
            // Set water
            document.getElementById('modalWater').textContent = dayData.water 
                ? `${dayData.water}/8 glasses` 
                : 'Not recorded';
            
            // Set macros
            const macros = dayData.macros || { protein: 0, carbs: 0, fat: 0 };
            
            // Calculate percentages
            const total = macros.protein + macros.carbs + macros.fat;
            const proteinPct = total > 0 ? Math.round(macros.protein / total * 100) : 0;
            const carbsPct = total > 0 ? Math.round(macros.carbs / total * 100) : 0;
            const fatPct = total > 0 ? Math.round(macros.fat / total * 100) : 0;
            
            // Update ring charts
            document.getElementById('proteinPercent').textContent = `${proteinPct}%`;
            document.getElementById('carbsPercent').textContent = `${carbsPct}%`;
            document.getElementById('fatPercent').textContent = `${fatPct}%`;
            
            // Update rings
            const ringCircumference = 2 * Math.PI * 35;
            
            const proteinRing = document.getElementById('proteinRing');
            proteinRing.style.strokeDasharray = ringCircumference;
            proteinRing.style.strokeDashoffset = ringCircumference * (1 - proteinPct / 100);
            
            const carbsRing = document.getElementById('carbsRing');
            carbsRing.style.strokeDasharray = ringCircumference;
            carbsRing.style.strokeDashoffset = ringCircumference * (1 - carbsPct / 100);
            
            const fatRing = document.getElementById('fatRing');
            fatRing.style.strokeDasharray = ringCircumference;
            fatRing.style.strokeDashoffset = ringCircumference * (1 - fatPct / 100);
            
            // Update gram values
            document.getElementById('proteinGrams').textContent = `${Math.round(macros.protein)}g`;
            document.getElementById('carbsGrams').textContent = `${Math.round(macros.carbs)}g`;
            document.getElementById('fatGrams').textContent = `${Math.round(macros.fat)}g`;
            
            // Set food list
            const foodList = document.getElementById('foodList');
            foodList.innerHTML = '';
            
            if (dayData.foods) {
                const mealTypes = {
                    breakfast: 'Breakfast',
                    lunch: 'Lunch',
                    dinner: 'Dinner',
                    snack: 'Snack'
                };
                
                let hasFoods = false;
                
                Object.entries(dayData.foods).forEach(([mealType, foods]) => {
                    if (foods && foods.length > 0) {
                        hasFoods = true;
                        
                        // Create meal header
                        const mealHeader = document.createElement('li');
                        mealHeader.className = 'meal-header';
                        mealHeader.textContent = mealTypes[mealType] || mealType;
                        foodList.appendChild(mealHeader);
                        
                        // Add foods
                        foods.forEach(food => {
                            const foodItem = document.createElement('li');
                            foodItem.className = 'food-item';
                            foodItem.innerHTML = `
                                <span class="food-name">${food.name}</span>
                                <span class="food-calories">${food.calories || 0} kcal</span>
                            `;
                            foodList.appendChild(foodItem);
                        });
                    }
                });
                
                if (!hasFoods) {
                    const noFoods = document.createElement('li');
                    noFoods.className = 'no-data';
                    noFoods.textContent = 'No food entries for this day';
                    foodList.appendChild(noFoods);
                }
            } else {
                const noFoods = document.createElement('li');
                noFoods.className = 'no-data';
                noFoods.textContent = 'No food entries for this day';
                foodList.appendChild(noFoods);
            }
            
            // Set exercise list
            const exerciseList = document.getElementById('exerciseList');
            exerciseList.innerHTML = '';
            
            // Check for new format (organized by time of day)
            const hasTimeBasedExercises = dayData.exercisesByTime && 
                (dayData.exercisesByTime.morning?.length > 0 || 
                 dayData.exercisesByTime.afternoon?.length > 0 || 
                 dayData.exercisesByTime.evening?.length > 0);
            
            if (hasTimeBasedExercises) {
                const timeSlots = ['morning', 'afternoon', 'evening'];
                let hasExercises = false;
                
                timeSlots.forEach(timeSlot => {
                    const exercises = dayData.exercisesByTime[timeSlot];
                    if (exercises && exercises.length > 0) {
                        hasExercises = true;
                        
                        // Create time header
                        const timeHeader = document.createElement('li');
                        timeHeader.className = 'meal-header';
                        timeHeader.textContent = timeSlot.charAt(0).toUpperCase() + timeSlot.slice(1);
                        exerciseList.appendChild(timeHeader);
                        
                        // Add exercises for this time
                        exercises.forEach(exercise => {
                            const exerciseItem = document.createElement('li');
                            exerciseItem.className = 'exercise-item';
                            exerciseItem.innerHTML = `
                                <span class="exercise-name">${exercise.name}</span>
                                <span class="exercise-details">
                                    ${exercise.duration || 0} min | ${exercise.calories || 0} kcal
                                </span>
                            `;
                            exerciseList.appendChild(exerciseItem);
                        });
                    }
                });
                
                if (!hasExercises) {
                    const noExercises = document.createElement('li');
                    noExercises.className = 'no-data';
                    noExercises.textContent = 'No exercise entries for this day';
                    exerciseList.appendChild(noExercises);
                }
            }
            // Fallback to old format if needed
            else if (dayData.exercises && dayData.exercises.length > 0) {
                dayData.exercises.forEach(exercise => {
                    const exerciseItem = document.createElement('li');
                    exerciseItem.className = 'exercise-item';
                    exerciseItem.innerHTML = `
                        <span class="exercise-name">${exercise.name}</span>
                        <span class="exercise-details">
                            ${exercise.duration || 0} min | ${exercise.calories || 0} kcal
                        </span>
                    `;
                    exerciseList.appendChild(exerciseItem);
                });
            } else {
                const noExercises = document.createElement('li');
                noExercises.className = 'no-data';
                noExercises.textContent = 'No exercise entries for this day';
                exerciseList.appendChild(noExercises);
            }
            
            // Show modal
            document.getElementById('dayDetailModal').classList.add('show');
        }
    </script>
    
    <style>
        /* Calendar Page Styles */
        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        
        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-button {
            background-color: var(--background-main);
            border: 1px solid var(--divider-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-button:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        .current-period {
            font-size: 18px;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }
        
        .view-type {
            display: flex;
            border: 1px solid var(--divider-color);
            border-radius: var(--input-border-radius);
            overflow: hidden;
        }
        
        .view-button {
            background-color: var(--background-main);
            color: var(--text-primary);
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Month Calendar View */
        .calendar-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 500;
            padding: 10px 0;
            text-align: center;
        }
        
        [data-theme="dark"] .calendar-header {
            color: var(--text-primary);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--divider-color);
        }
        
        .calendar-day {
            min-height: 100px;
            background-color: var(--card-bg);
            padding: 10px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        
        .calendar-day:hover {
            background-color: var(--primary-light);
        }
        
        .calendar-day.empty {
            background-color: var(--background-main);
            cursor: default;
        }
        
        .calendar-day.today {
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        [data-theme="dark"] .calendar-day:hover {
            background-color: var(--primary-dark);
        }
        
        [data-theme="dark"] .calendar-day.today {
            background-color: rgba(76, 175, 80, 0.15);
        }
        
        .calendar-day.today .day-number {
            background-color: var(--primary-color);
            color: white;
        }
        
        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 500;
        }
        
        .day-content {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .day-indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .day-indicator.weight {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }
        
        .day-indicator.calories {
            background-color: rgba(255, 152, 0, 0.1);
            color: #FF9800;
        }
        
        .day-indicator.exercise {
            background-color: rgba(233, 30, 99, 0.1);
            color: #E91E63;
        }
        
        .day-indicator.water {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        [data-theme="dark"] .day-indicator.weight {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81C784;
        }
        
        [data-theme="dark"] .day-indicator.calories {
            background-color: rgba(255, 152, 0, 0.2);
            color: #FFB74D;
        }
        
        [data-theme="dark"] .day-indicator.exercise {
            background-color: rgba(233, 30, 99, 0.2);
            color: #F48FB1;
        }
        
        [data-theme="dark"] .day-indicator.water {
            background-color: rgba(33, 150, 243, 0.2);
            color: #64B5F6;
        }
        
        /* Week View */
        .week-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .week-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 500;
            text-align: center;
        }
        
        [data-theme="dark"] .week-header {
            color: var(--text-primary);
        }
        
        .week-day {
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .day-name {
            font-size: 13px;
            white-space: nowrap;
        }
        
        .day-date {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .day-date.today {
            background-color: var(--primary-color);
            color: white;
        }
        
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--divider-color);
        }
        
        .week-day-detail {
            min-height: 220px;
            background-color: var(--card-bg);
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .week-day-detail:hover {
            background-color: var(--primary-light);
        }
        
        .week-day-detail.today {
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        [data-theme="dark"] .week-day-detail:hover {
            background-color: var(--primary-dark);
        }
        
        [data-theme="dark"] .week-day-detail.today {
            background-color: rgba(76, 175, 80, 0.15);
        }
        
        .detail-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        .detail-row i {
            width: 16px;
            text-align: center;
        }
        
        .detail-row.weight i {
            color: #4CAF50;
        }
        
        .detail-row.calories i {
            color: #FF9800;
        }
        
        .detail-row.exercise i {
            color: #E91E63;
        }
        
        .detail-row.water i {
            color: #2196F3;
        }
        
        .detail-row.macros i {
            color: #9C27B0;
        }
        
        [data-theme="dark"] .detail-row.weight i {
            color: #81C784;
        }
        
        [data-theme="dark"] .detail-row.calories i {
            color: #FFB74D;
        }
        
        [data-theme="dark"] .detail-row.exercise i {
            color: #F48FB1;
        }
        
        [data-theme="dark"] .detail-row.water i {
            color: #64B5F6;
        }
        
        [data-theme="dark"] .detail-row.macros i {
            color: #CE93D8;
        }
        
        .macro-bars {
            flex: 1;
        }
        
        .macro-bar-container {
            display: flex;
            height: 6px;
            width: 100%;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .macro-bar {
            height: 100%;
        }
        
        .macro-bar.protein {
            background-color: #E91E63;
        }
        
        .macro-bar.carbs {
            background-color: #2196F3;
        }
        
        .macro-bar.fat {
            background-color: #FF9800;
        }
        
        /* Day Detail Modal */
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .calendar-modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--divider-color);
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 1;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        /* Day Summary */
        .day-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            background-color: var(--background-main);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .summary-item i {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .summary-item:nth-child(1) i {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .summary-item:nth-child(2) i {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .summary-item:nth-child(3) i {
            color: #E91E63;
            background-color: rgba(233, 30, 99, 0.1);
        }
        
        .summary-item:nth-child(4) i {
            color: #2196F3;
            background-color: rgba(33, 150, 243, 0.1);
        }
        
        .summary-item h3 {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .summary-item p {
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Macro Charts */
        .modal-macros {
            background-color: var(--background-main);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .modal-macros h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .macro-rings {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .macro-ring {
            text-align: center;
        }
        
        .macro-ring p {
            margin: 10px 0 0 0;
            color: var(--text-secondary);
        }
        
        .ring {
            overflow: visible;
        }
        
        .ring-bg {
            fill: none;
            stroke: var(--divider-color);
            stroke-width: 5;
        }
        
        .ring-fg {
            fill: none;
            stroke-width: 5;
            stroke-linecap: round;
            transform-origin: center;
            transform: rotate(-90deg);
        }
        
        .protein-ring {
            stroke: #E91E63;
            stroke-dasharray: 220;
            stroke-dashoffset: 220;
        }
        
        .carbs-ring {
            stroke: #2196F3;
            stroke-dasharray: 220;
            stroke-dashoffset: 220;
        }
        
        .fat-ring {
            stroke: #FF9800;
            stroke-dasharray: 220;
            stroke-dashoffset: 220;
        }
        
        .ring-text {
            font-size: 12px;
            font-weight: 500;
            fill: var(--text-primary);
        }
        
        .macro-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .macro-label {
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            font-weight: 500;
        }
        
        .macro-label.protein {
            background-color: rgba(233, 30, 99, 0.1);
            color: #E91E63;
        }
        
        .macro-label.carbs {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        .macro-label.fat {
            background-color: rgba(255, 152, 0, 0.1);
            color: #FF9800;
        }
        
        /* Food & Exercise Lists */
        .food-list, .exercise-list {
            background-color: var(--background-main);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .food-list h3, .exercise-list h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .food-list ul, .exercise-list ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .meal-header {
            font-weight: 500;
            color: var(--text-primary);
            padding: 10px 0;
            margin-top: 10px;
            border-bottom: 1px solid var(--divider-color);
        }
        
        .food-item, .exercise-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed var(--divider-color);
            font-size: 14px;
        }
        
        .food-calories, .exercise-details {
            color: var(--text-secondary);
        }
        
        .no-data {
            padding: 15px 0;
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .view-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 8px;
            }
            
            .day-content {
                margin-top: 20px;
            }
            
            .day-indicator {
                font-size: 10px;
                padding: 1px 4px;
            }
            
            .day-summary {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .day-name {
                font-size: 11px;
            }
        }
    </style>
</body>
</html>